name: Run E2E Tests

on: [pull_request]

jobs:
  run-e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: docker
          POSTGRES_DB: nest-challenge

      cache:
        image: redis
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"
      - run: npm ci
      - run: npm run test:e2e
        env:
          DATABASE_URL: "postgresql://postgres:docker@localhost:5432/nest-challenge?schema=public"
          JWT_PRIVATE_KEY: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUI3WUxQK0RMTVRPYkZDaDd1dHVzcm5MQWhRVnFhdmUrUm5SNU1aZmVQejhBaEo0R0RTCm05bE9IL2RYK0c2UmlQUzV4RDI3MXg1RXdPa1h2c2lSclRBdEQvYmtRZEhsTGVpblh1Z2NVQitIbjBJOS9qZE0KQzZ1Y2NiSWdGK0lDT3ZGcUVCNDlkd1B6Y3k3V0xSeEVFSFRlcVJmM1hLaTMyVDk1L08zaFFKcEpKZkhTd2ZzcQprMGgxY2ZVdUUydzVjZlRhSll2dkNhZ1dQWVJiN21ZWG1NUVUyeFcxYVU0TWFrblR2NjhsOFJYb1R3SzFjYzhoCnZXOS9pMWhsaEtTMHEwYWdIM0ZZRkxzQXN1cWtCRW8xQW9JR1VPTlRwUnNCZjBEQzZoWEVFcUhHWlRBNk5vS3IKVnVIMDhyWDVoMHppaEZkYldsWHdtbTJlTWhKRndQY25Dem8vQWdNQkFBRUNnZ0VBRkhQRFlxbllSYWVhcXR5MQpUK2RYRzF0QlJaQVhzWjlvRFhiZis2blN6KzFLY25Tdm1Eb2RtOFhReXRSei84d2tSV2N5bEtEa2M2RkhBcGl0Cnh2aGV0Qm1oWTlWRlppaG1HTml5d1g3R3UwUzdSbXVOM3gxUUpXN3ppRDV0U05GY2s2aDRXdGdQMzV1SWVCaWkKUnVZemVYV3VjMkw0MVFFK2RJcHBKSjRBOVg4SEVDQ1dHWjlrTjdSNjlSbG9JOU9ybTFyVGI3Y0NCejkvaTUrOAoxczNoMHVVdk1LVXpyNDdMZFVkOU9UTmx0QlVQdGRtVU1tOGl4N1Rtb2xSNlFpUVRWL0NVU3lSRERiRWxRcDZICklacEdPa09LWXBNa1Z0cWY3VUZlbW5MUEUwcS90LzRCekt3ZnROZFNDWW1hRm5CcFBWK255dmRUdWw0c2tmaFUKWnQ4S0FRS0JnUUR4aEthZ2VCOUhqZE12R1FBNk1KczRpVVlWZ0xBbUo1Zy9zVjdlRWRQdlk3dk9PeFRQRnhXegpBMlpwY1JIYndQUzA2eGFXUEpDZUZJY084dnZVYlJ3Q2VWOVV2K2VUd0c1ZzlkWU1pd1NZUWxOVFFaSjk4OWZPCkdWSVViMXFnVmVQaE9VR1pXdkNZNzBMK1U5RmVwa0c5OHVGWlZ1bzRHR0VXc2o2YlpBWDBqd0tCZ1FDQ3hwTVoKL0RoOEJsVFFhYzJDeUhkY2t4UGx5RFpuTkZ2M0hURno0dFIyYXRTVVFPczBNZmtXNkFnbkpyZ0syVzZTNSt3ago0REg1T0xFQTQyRk9iVTBvV0d6Z3Y0LzU5a1daYlQ0NUl2dlg4RC9QUkVaNjRyS1pUM1JKRUhHbmtGSWNDbStYClAzdDc1ZG5JTjFoWHpTcmFyNFZPaXFESUpVRExzTTA4Zk5BWFVRS0JnUUMrNXRVMlhmeUxlSVVHNDBJVXZMclUKYzEwY1BmMytDcW9ESGxZWVBndEJXNW5sSnpvSmZ2dTk1ZUFiVkM2RGZ2OXR5YXl1eit5WHB5NGlHTm9KVEwwcApEM3JVNkdOSm5IOGkwTzZDTjVoSUtaVG5hQnM4eDNNN0N6U2Z4bXpoODBJT2trMVJ4Rm9NNklJUnVYcnl6NE9ECmV1bTR6a1NRVm1UWHBjaHExeU1GN1FLQmdIa2tRNzROZzdGNEYvY2NHM0NzRE0zbnZNWGR5bStkOUJjY3B1UEgKMnJKN1VjS254SG1NVlViZjJEV1VTMlpaZG5HRmY1ellJTkxScmoyNVpEbEhUUE16dm1BUGMrckVORUxsREgvWApKVjRxUXFIWWlFVnJYTEJpQnNGc0J5eUdwMWtzWGFUSS9MV1AvVWJYNWZFbnNDdjE3ZElNM3RXb2xMWmJhRE5CCkYyNlJBb0dBTWNDZFZyYm14NnJ3WE40OTdkQjR0K3R3bjV3WDJSeUZVZUg4ODJLdit2R2EycVlwR1kydnJlUmUKRXVYYWFiUExBNnozK3VrbWlKUVNKR1ZpSWQ2bTNIeS94NWJVSmQyaGUyVE5VdndJM09nNG5lQTFnR1hBbEUweQo5RHhaWFFoQTBLbHpxYUJCUFY1eXFVNGlEMi8vTU9EYXdIUFptNnFHcEtDWjlGZDdHWTA9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0t"
          JWT_PUBLIC_KEY: s"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklUQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FRNEFNSUlCQ1FLQ0FRQjdZTFArRExNVE9iRkNoN3V0dXNybgpMQWhRVnFhdmUrUm5SNU1aZmVQejhBaEo0R0RTbTlsT0gvZFgrRzZSaVBTNXhEMjcxeDVFd09rWHZzaVJyVEF0CkQvYmtRZEhsTGVpblh1Z2NVQitIbjBJOS9qZE1DNnVjY2JJZ0YrSUNPdkZxRUI0OWR3UHpjeTdXTFJ4RUVIVGUKcVJmM1hLaTMyVDk1L08zaFFKcEpKZkhTd2ZzcWswaDFjZlV1RTJ3NWNmVGFKWXZ2Q2FnV1BZUmI3bVlYbU1RVQoyeFcxYVU0TWFrblR2NjhsOFJYb1R3SzFjYzhodlc5L2kxaGxoS1MwcTBhZ0gzRllGTHNBc3Vxa0JFbzFBb0lHClVPTlRwUnNCZjBEQzZoWEVFcUhHWlRBNk5vS3JWdUgwOHJYNWgwemloRmRiV2xYd21tMmVNaEpGd1BjbkN6by8KQWdNQkFBRT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0t"
          AWS_BUCKET_NAME: "ignite-nest-clean"
          CLOUDFLARE_ACCOUNT_ID: "584075bcc0c6c67478761fe805d67a79"
          AWS_ACCESS_KEY_ID: "c3c2b62831a0479fcfc453f02c04d142"
          AWS_SECRET_ACCESS_KEY: "9d926492911c6a58816bf1fb8796c0485020c94637c69d4edacff75095fe3af8"
